#!/bin/bash
# Generated by jinja2 template

fcp="{{ fcp }}"
lun="{{ lun }}"
target_filename="{{ target_filename }}"

enable_zfcp_mod=`lsmod | grep zfcp`
if [ -z "$enable_zfcp_mod" ];then
    modprobe zfcp
else
    echo "zfcp mode is already enabled"
fi

/sbin/cio_ignore -r $fcp > /dev/null
/sbin/chccwdev -e $fcp > /dev/null

declare -a ActiveWWPNs

ActiveWWPNs=(`ls /sys/bus/ccw/drivers/zfcp/0.0.$fcp/ | grep "0x"`)

HostName=`lszfcp | grep "$fcp" | cut -d " " -f 2`

NPIV=`cat /sys/bus/ccw/drivers/zfcp/0.0.$fcp/$HostName/fc_host/$HostName/port_type`

AutoScan=`cat /sys/module/zfcp/parameters/allow_lun_scan`
if [[ "$AutoScan" != "Y" || "$NPIV" != "NPIV VPORT" ]]; then
    for wwpn in $ActiveWWPNs
    do
        chzdev -e -a zfcp-lun 0.0.$fcp:$wwpn:$lun
        echo "$lun" > /sys/bus/ccw/drivers/zfcp/0.0.$fcp/$wwpn/unit_add
    done
fi

for wwpn in ${ActiveWWPNs[@]}
do
    echo "0.0.$fcp $wwpn $lun" >> /etc/zfcp.conf
done

echo "add" >> /sys/bus/ccw/devices/0.0.$fcp/uevent
if [[ $(which udevadm 2> /dev/null) != '' ]]; then
    udevadm settle
else
    udevsettle
fi

SourceDevices=(`ls /dev/disk/by-path/ | grep "ccw-0.0.$fcp-zfcp-.*:$lun"`)

SourceDevice="/dev/disk/by-path/${SourceDevices[0]}"
if [[ ! -e $SourceDevice ]]; then
    maxTime=20
    while [ $maxTime -gt 0]
    do
      if [[ -e $SourceDevice ]]; then
        break
      fi
      sleep 2
      ((maxTime-=2))
    done
fi

enable_multipath_mod=`lsmod | grep dm_multipath`
if [ -z "$enable_multipath_mod" ];then
    modprobe dm-multipath
    echo -e "#blacklist {
    #	devnode \"*\"
    #}
    " > /etc/multipath.conf
    mpathconf
    systemctl restart multipathd.service
else
    echo "dm-multipath mode is already enabled"
fi

for host in `ls /sys/class/scsi_host/`
do
    echo "- - -" > /sys/class/scsi_host/$host/scan
done

WWID=`/lib/udev/scsi_id --page 0x83 --whitelisted /dev/disk/by-path/${SourceDevices[0]}`

TargetFile="$target_filename"

ConfigLib="/lib/udev/rules.d/56-zfcp.rules"
if [ -e "$ConfigLib" ]
then
    ConfigFile="/lib/udev/rules.d/56-zfcp.rules"
else
    ConfigFile="/etc/udev/rules.d/56-zfcp.rules"
fi

wwid_existed=`cat "$ConfigFile" | grep "$WWID"`
if [ -z "$wwid_existed" ];then
    LinkItem="KERNEL==\"dm-*\", ENV{DM_UUID}==\"mpath-$WWID\", SYMLINK+=\"$TargetFile\""
    echo -e $LinkItem >> $ConfigFile
else
    echo "$WWID" already in "$ConfigFile"
fi

udevadm control --reload
udevadm trigger --sysname-match=dm-*
