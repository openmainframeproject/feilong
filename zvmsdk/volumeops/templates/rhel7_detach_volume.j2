#!/bin/bash
#Generated by jinja2 template

fcp="{{ fcp }}"
lun="{{ lun }}"
target_filename="{{ target_filename }}"

SourceDevices=(`ls /dev/disk/by-path/ | grep "ccw-0.0.$fcp-zfcp-.*:$lun"`)

declare -a WWIDs
i=0
for SourceDevice in ${SourceDevices[@]}
do
    WWIDs[i]=`/lib/udev/scsi_id --page 0x83 --whitelisted /dev/disk/by-path/$SourceDevice`
    let i=i+1
done

declare -a ActiveWWPNs
ActiveWWPNs=(`ls /sys/bus/ccw/drivers/zfcp/0.0.$fcp/ | grep "0x"`)

for WWID in ${WWIDs[@]}
do
    multipath -f $WWID
done

for SourceDevice in ${SourceDevices[@]}
do
    RealPath=`readlink -f /dev/disk/by-path/$SourceDevice`
    blockdev --flushbufs $RealPath > /dev/null
    SdxName=`echo "$RealPath" | cut -d "/" -f 3`
    echo 1 > /sys/block/$SdxName/device/delete
done

for WWPN in ${ActiveWWPNs[@]}
do
    sed -i -e "/0.0.$fcp $WWPN $lun/d" /etc/zfcp.conf
done


TargetFile="$target_filename"

ConfigLib="/lib/udev/rules.d/56-zfcp.rules"
if [ -e "$ConfigLib" ]
then
    ConfigFile="/lib/udev/rules.d/56-zfcp.rules"
else
    ConfigFile="/etc/udev/rules.d/56-zfcp.rules"
fi
sed -i -e /SYMLINK+=\"$TargetFile\"/d $ConfigFile

udevadm control --reload
udevadm trigger --sysname-match=dm-*
